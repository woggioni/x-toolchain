# $Id$
# Maintainer:  Bart≈Çomiej Piotrowski <bpiotrowski@archlinux.org>
# Contributor: Allan McRae <allan@archlinux.org>
# Contributor: Aaron Griffin <aaron@archlinux.org>

pkgname=${_target}-bash
_basename="${pkgname#${_target}-}"
_basever=5.1
_patchlevel=008
pkgver=${_basever}.${_patchlevel}
pkgrel=1
pkgdesc='The GNU Bourne Again shell'
arch=(x86_64)
license=(GPL)
options=(staticlibs !buildflags)
url='http://www.gnu.org/software/bash/bash.html'
groups=(base)
backup=("./${_prefix}/${_target}/sysroot/etc/"bash.bash{rc,_logout} "./${_prefix}/${_target}/sysroot/etc/skel/".bash{rc,_profile,_logout})
depends=("${_target}-readline>=7.0" "${_target}-gcc" "${_target}-ncurses")
makedepends=("${_target}-configure")
optdepends=("${_target}-bash-completion: for tab completion")
provides=("${_target}-sh")
source=(https://ftp.gnu.org/gnu/bash/bash-$_basever.tar.gz{,.sig}
        dot.bashrc
        dot.bash_profile
        dot.bash_logout
        system.bashrc
        system.bash_logout)
validpgpkeys=('7C0135FB088AAF6C66C650B9BB5869F064EA74AB') # Chet Ramey

if [[ $((10#${_patchlevel})) -gt 0 ]]; then
  for (( _p=1; _p<=$((10#${_patchlevel})); _p++ )); do
    source=(${source[@]} https://ftp.gnu.org/gnu/bash/bash-$_basever-patches/bash${_basever//.}-$(printf "%03d" $_p){,.sig})
  done
fi

prepare() {
  cd $_basename-$_basever

  for (( _p=1; _p<=$((10#${_patchlevel})); _p++ )); do
    msg "applying patch bash${_basever//.}-$(printf "%03d" $_p)"
    patch -p0 -i ../bash${_basever//.}-$(printf "%03d" $_p)
  done
}

build() {
  cd $_basename-$_basever

  _bashconfig=(-DDEFAULT_PATH_VALUE=\'\"/usr/local/sbin:/usr/local/bin:/usr/bin\"\'
               -DSTANDARD_UTILS_PATH=\'\"/usr/bin\"\'
               -DSYS_BASHRC=\'\"/etc/bash.bashrc\"\'
               -DSYS_BASH_LOGOUT=\'\"/etc/bash.bash_logout\"\'
               -DNON_INTERACTIVE_LOGIN_SHELLS)
  export CFLAGS="${CFLAGS} ${_bashconfig[@]}"

  ${_target}-configure --with-curses --enable-readline \
    --without-bash-malloc --with-installed-readline .
  make
}

package() {
  make -C $_basename-$_basever DESTDIR="$pkgdir" install
  ln -s bash "$pkgdir/${_prefix}/${_target}/sysroot/usr/bin/sh"

  # system-wide configuration files
  install -Dm644 system.bashrc "$pkgdir/${_prefix}/${_target}/sysroot/etc/bash.bashrc"
  install -Dm644 system.bash_logout "$pkgdir/${_prefix}/${_target}/sysroot/etc/bash.bash_logout"

  # user configuration file skeletons
  install -dm755 "$pkgdir/${_prefix}/${_target}/sysroot/etc/skel/"
  install -m644 dot.bashrc "$pkgdir/${_prefix}/${_target}/sysroot/etc/skel/.bashrc"
  install -m644 dot.bash_profile "$pkgdir/${_prefix}/${_target}/sysroot/etc/skel/.bash_profile"
  install -m644 dot.bash_logout "$pkgdir/${_prefix}/${_target}/sysroot/etc/skel/.bash_logout"
  rm "$pkgdir/${_prefix}/${_target}/sysroot/usr/share/info/dir"
}

sha256sums=('cc012bc860406dcf42f64431bcd3d2fa7560c02915a601aba9cd597a39329baa'
            'SKIP'
            '3e22bf86ae6708df7a6bceb88c67a00118275f9c0b5268f453dd388af7c43b53'
            'e149407c2bee17779caec70a7edd3d0000d172e7e4347429b80cb4d55bcec9c2'
            '4330edf340394d0dae50afb04ac2a621f106fe67fb634ec81c4bfb98be2a1eb5'
            '5fdc20c44bc9058f728d11111327f4dbb5598fec4d948dd5265211598667f9f0'
            '025bccfb374a3edce0ff8154d990689f30976b78f7a932dc9a6fcef81821811e'
            'ebb07b3dbadd98598f078125d0ae0d699295978a5cdaef6282fe19adef45b5fa'
            'SKIP'
            '15ea6121a801e48e658ceee712ea9b88d4ded022046a6147550790caf04f5dbe'
            'SKIP'
            '22f2cc262f056b22966281babf4b0a2f84cb7dd2223422e5dcd013c3dcbab6b1'
            'SKIP'
            '9aaeb65664ef0d28c0067e47ba5652b518298b3b92d33327d84b98b28d873c86'
            'SKIP'
            'cccbb5e9e6763915d232d29c713007a62b06e65126e3dd2d1128a0dc5ef46da5'
            'SKIP'
            '75e17d937de862615c6375def40a7574462210dce88cf741f660e2cc29473d14'
            'SKIP'
            'acfcb8c7e9f73457c0fb12324afb613785e0c9cef3315c9bbab4be702f40393a'
            'SKIP'
            'f22cf3c51a28f084a25aef28950e8777489072628f972b12643b4534a17ed2d1'
            'SKIP')

strip() {
    ${_target}-strip $@
}
export -f strip